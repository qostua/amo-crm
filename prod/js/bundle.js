(()=>{"use strict";const e="PAST",t="PRESENT",r="FUTURE",s={PAST:"Задача просрочена",PRESENT:"Задача на сегодня",FUTURE:"Задача на будущее"},i="HUMAN",a="ISO",d=(e,t=i)=>{const r=new Date(1e3*e),s=r.getDate().toString().padStart(2,"0"),d=(r.getMonth()+1).toString().padStart(2,"0");switch(t){case i:return`${s}.${d}.${r.getFullYear()}`;case a:return r.toISOString()}},o="GOOD",n="BAD",c={padding:"10px",fontWeight:"700",color:"#FFFFFF",textAlign:"center",width:"100%",position:"fixed",top:"0",left:"0",zIndex:"50"},l=(e,t=n)=>{const r=document.createElement("div");r.textContent=e;for(let e in c)r.style[e]=c[e];switch(t){case n:r.style.backgroundColor="var(--error)";break;case o:r.style.backgroundColor="var(--success)"}const s=setTimeout((()=>r.remove()),3e3);r.addEventListener("click",(()=>{r.remove(),clearTimeout(s)}),{once:!0}),document.body.append(r)};const h=new class{#e;#t;#r;constructor({endPoint:e,bearerToken:t,loadLimit:r}){this.#e=e,this.#t=t,this.#r=r}getOffers({page:e=1}){return this.#s({url:"leads",params:{limit:this.#r,page:e}}).then(this.#i)}getOneOffer({id:e}){return this.#s({url:`leads/${e}`}).then(this.#i)}async#s({url:e,method:t="GET",body:r=null,headers:s=new Headers,params:i={}}){s.append("Authorization",`Bearer ${this.#t}`);const a=new URL(`${this.#e}/${e}`),d=new URLSearchParams(i);a.search=d.toString();const o=await fetch(a,{method:t,body:r,headers:s});try{return this.#a(o),o}catch(e){this.#d(e)}}#i(e){return e.json()}#a(e){if(!e.ok)throw new Error(`${e.status}: ${e.statusText}`)}#d(e){throw e}}({endPoint:"https://qostua.amocrm.ru/api/v4",bearerToken:"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImE2MzY3NDNiMDc4NjNmOTg5ZjM2Y2JiYWYxODUwYzBmMmU0MWYyMzM4ODljOGUxNzRlYjZmM2I3NDUxNWRhMjZmMWFkYmVlY2ZlNzIwMGNjIn0.eyJhdWQiOiI5ZWQ3YTM2YS1lYTNiLTRiMzEtYTMzYi0zYzU2MzE0YThmMjkiLCJqdGkiOiJhNjM2NzQzYjA3ODYzZjk4OWYzNmNiYmFmMTg1MGMwZjJlNDFmMjMzODg5YzhlMTc0ZWI2ZjNiNzQ1MTVkYTI2ZjFhZGJlZWNmZTcyMDBjYyIsImlhdCI6MTcyNTk5MzE0NCwibmJmIjoxNzI1OTkzMTQ0LCJleHAiOjE3MzMyNzA0MDAsInN1YiI6IjExNDk2NzQyIiwiZ3JhbnRfdHlwZSI6IiIsImFjY291bnRfaWQiOjMxOTQxNDQ2LCJiYXNlX2RvbWFpbiI6ImFtb2NybS5ydSIsInZlcnNpb24iOjIsInNjb3BlcyI6WyJjcm0iLCJmaWxlcyIsImZpbGVzX2RlbGV0ZSIsIm5vdGlmaWNhdGlvbnMiLCJwdXNoX25vdGlmaWNhdGlvbnMiXSwiaGFzaF91dWlkIjoiMmU3MzFhNmMtMmFhZi00ZDc3LTllZTAtZDllYTIwMDJmOTU2IiwiYXBpX2RvbWFpbiI6ImFwaS1iLmFtb2NybS5ydSJ9.lUNLpFwFRlGFE8wj0pE0sx5o-KmPRSph0oR0LJg0-KodUWNOkrQFJCUM25lnvlWXcjwD1iRtXdprdAS-nRKEeUDUMCcZ31L17YaXlT449p1A9nxoNL2ECjEa3OnIdiozSx2Mgzx_87Y_XU09iUEu5B0EFx25FLeCYiANVoHzYpHqThyVaKqKrAprRrm7mdQFnHbSqLgwJK3T2BJd-as-DJ0BNot3pJjaGlrqool8RfTbirmcXVKIEYetK-xrNYF6ixtFgC97IK9FXXJbegLZ4HMbYBYrH8WyHMCEy7cug7-KU5xwIk0cIZUb4-1J-X8MmOPRSfWypMK68kMQ6ySQjA",loadLimit:3}),f=new class{#o=null;#n=0;#c=[];#l=document.querySelector(".offers__table");#h=document.querySelector(".select-offer");constructor({offersApiService:e,timeoutLoad:t}){this.#o=e,this.#n=t}async init(){await this.#f(),this.#m(),this.#O()}async#f(e=1){try{const t=await this.#o.getOffers({page:e});this.#c.push(...this.#N(t));const r=this.#p(t);r?setTimeout((()=>this.#f(r)),this.#n):this.#g()}catch(e){this.#c=[],l("Ошибка при получении сделок. Обновите страницу")}}async#u(e){try{const t=await this.#o.getOneOffer({id:e});this.#S(t),this.#T()}catch(e){this.#b(),l("Ошибка при получении сделки. Обновите страницу")}}#g(){this.#l.innerHTML=this.#I()+this.#c.map(this.#M).join(""),document.body.classList.remove("page--loading")}#M(e,t){return`<tr data-offer-id="${e.id}">\n      <td>${t+1}</td>\n      <td>${e.name}</td>\n      <td>${r=e.price,r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"&nbsp;")+"&nbsp;$"}</td>\n      <td>${e.id}</td>\n    </tr>`;var r}#I(){return"<tr>\n      <th>#</th>\n      <th>Название</th>\n      <th>Бюджет</th>\n      <th>ID</th>\n    </tr>"}#S(i){this.#h.classList.add("select-offer--active");const o=this.#h.querySelector(".select-offer__content"),n=(s=>{let i=new Date;const a=new Date(1e3*s).getDate()-i.getDate();return a>0?r:a<0?e:t})(i.closest_task_at),c=s[n];o.innerHTML=`<h2 class="select-offer__title">\n      ${i.name}\n    </h2>\n\n    <dl class="select-offer__data">\n      <div>\n        <dt>ID</dt>\n        <dd>${i.id}</dd>\n      </div>\n      <div>\n        <dt>Дата</dt>\n        <dd>\n          <time datetime="${d(i.closest_task_at,a)}">\n            ${d(i.closest_task_at)}\n          </time>\n        </dd>\n      </div>\n      <div>\n        <dt>Статус</dt>\n        <dd>\n          <svg data-status="${n}" width="16" height="16" fill="currentColor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">\n            <circle cx="50" cy="50" r="50" />\n          </svg>\n          <span class="select-offer__data-status-label">\n            ${c}\n          </span>\n        </dd>\n      </div>\n    </dl>`}#v(e){this.#w(),e.classList.add("active")}#w(){const e=this.#l.querySelector(".active");e&&e.classList.remove("active")}#L(){this.#h.classList.add("select-offer--loading")}#b(){this.#h.classList.remove("select-offer--active"),this.#h.classList.remove("select-offer--loading")}#T(){this.#h.classList.remove("select-offer--loading")}#m(){this.#l.addEventListener("click",(e=>{const t=e.target.closest("td");if(!t)return;this.#L();const r=t.closest("tr"),s=r.dataset.offerId;this.#u(s).then((()=>this.#v(r)))}))}#O(){this.#h.addEventListener("click",(e=>{e.target.closest(".select-offer__content")||(this.#h.classList.remove("select-offer--active"),this.#w())}))}#N(e){return e._embedded.leads}#p(e){return e._links.next?e._page+1:null}}({offersApiService:h,timeoutLoad:1e3});f.init().catch((e=>{throw l("Ошибка при загрузке. Обновите страницу"),e}))})();